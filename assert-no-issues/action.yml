name: 'API Call and Parse JSON'
description: 'Calls an API using a configurable domain, parses the JSON response, and fails the job if insights are found.'
inputs:
  digma_url:
    description: 'The Digma API to call'
    required: true
  api_token:
    description: 'Authorization token for API access'
    required: true
  environment:
    description: 'Digma environment'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Call API and Check Response
      shell: bash
      run: |
        domain="${{ inputs.digma_url }}"
        api_token="${{ inputs.api_token }}"
        response=$(curl -X 'GET' \
          "${domain}/Insights/get_insights_view?Page=0&PageSize=2&ShowDismissed=false&ShowUnreadOnly=true&DirectOnly=false&Environment=PETCLINIC_CI&InsightViewType=Issues" \
          -H 'accept: application/json' \
          -H "Authorization: Token $api_token" \
          -s)
        echo "$response" | jq . > response.json  # Save the formatted JSON to a file
        
        if jq -e '.insights | length > 0' response.json > /dev/null; then
          jq -r '.insights[] | "* \(.type):  \"\(.spanInfo.displayName)\""' response.json
          echo "::error ::Found new issues"
          exit 1
        else
          echo "No new issues found"
        fi  # This is where the 'if' block is closed
